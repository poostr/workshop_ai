# CLEAN-005 Приборка этапа E

## Context

- Тесты должны быть быстрыми и стабильными
- Должно быть устранено дублирование кода
- База данных для тестов должна быть приближена к production (PostgreSQL)

## Выполненные работы

1. **Рефакторинг фикстур (`conftest.py`)**
   - Добавлены фикстуры `client` и `db_engine`.
   - Настроено автоматическое создание БД, прогон миграций, и yield `TestClient` с зависимостями.
   - Очищение кешей (`get_settings.cache_clear()`) перенесено в teardown генератора `client`.

2. **Автоматический и ручной рефакторинг тестов (`test_*.py`)**
   - Удалены ручные `test_db_url` из всех тестов.
   - Во всех функциях вместо `(database_url: str)` теперь принимаются `(client: TestClient, db_engine)`.
   - Восстановлена работоспособность всех 49 тестов (5.16s). Ошибок валидации или некорректных статусов нет.
   - Устранены дублирующиеся куски кода `app = create_app()`, `TestClient()`, `engine = create_engine()`.

3. **Исправление ошибок линтеров (`ruff check`)**
   - Устранены ошибки F821 (неопределённые переменные), F841 (неиспользуемые переменные), F401 (неиспользуемые импорты).
   - Для всех файлов успешно пройден `make backend-lint`.

## Проверка по DoD

- [x] Удалены флейки и лишние ожидания
- [x] Тестовые данные централизованы, нет дублирования

**Full Backend Quality Gate Result:**
- `make backend-lint` — OK (0 warnings)
- `make backend-test` — OK (49 passed)

**Conclusion:**
Тесты стабилизированы, фикстуры приведены к единому стандарту для комфортной разработки в дальнейшем (этап D и далее).
