# Отчёт по задаче API-005

## Статус

Выполнено.

## Что сделано

- Реализован endpoint `POST /api/v1/types/{id}/move` в `backend/app/api/v1/router.py`:
  - добавлена проверка перехода только вперёд по pipeline (`ERR_INVALID_STAGE_TRANSITION`);
  - добавлена блокировка строк `stage_counts` через `SELECT ... FOR UPDATE` для источника и цели;
  - добавлена проверка достаточности остатка (`ERR_INSUFFICIENT_QTY`);
  - добавлено атомарное обновление счётчиков и append-запись в `history_logs`;
  - endpoint возвращает актуальные counts типа после успешного перемещения.
- Выполнен рефакторинг роутера для переиспользования логики сборки карточки типа:
  - добавлены `_iter_type_rows_by_id` и `_build_type_item_by_id`;
  - `GET /api/v1/types/{id}` переведён на новые helper-функции.
- В `backend/app/domain/stages.py` добавлен helper `is_forward_transition` и индекс порядка стадий `STAGE_INDEX`.
- Добавлены интеграционные тесты `backend/tests/test_type_move_api.py`:
  - успешное перемещение;
  - ошибка при недостатке остатка;
  - ошибка при попытке перехода назад.
- В `BACKLOG.md` задача `API-005` отмечена как выполненная.
- В `CHANGELOG.md` добавлена запись по задаче.

## Верификация

- `make quality` — успешно (backend format/lint/tests, frontend format/lint/typecheck/build/test).

## Принятые решения

- ADR: [`ADR-0016`](../ADR/ADR-0016-atomic-forward-move-endpoint-api-005.md)
