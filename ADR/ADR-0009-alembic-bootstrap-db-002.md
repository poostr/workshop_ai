# ADR-0009: Верификация bootstrap-миграции Alembic (DB-002)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: DB-002

## Контекст

В репозитории уже присутствуют Alembic-конфигурация, первая миграция и автопрогон `alembic upgrade head` в `entrypoint.sh`, но задача `DB-002` оставалась незакрытой в `BACKLOG.md`.

Для снижения риска регресса нужен воспроизводимый тест, подтверждающий, что миграция реально поднимает схему до `head`, а не только существует как файлы в дереве проекта.

## Решение

1. Добавить интеграционный тест `backend/tests/test_migrations.py`.
2. В тесте запускать `alembic upgrade head` через Alembic API с временной SQLite-БД.
3. После применения миграций валидировать наличие ожидаемых таблиц:
   - `miniature_types`;
   - `stage_counts`;
   - `history_logs`;
   - `alembic_version`.
4. Явно очищать кэш `get_settings()` до и после теста, чтобы источник `DATABASE_URL` из окружения всегда применялся детерминированно.

## Последствия

- Положительные:
  - DoD `DB-002` подтверждается автоматически в тестовом прогоне, а не только вручную через `docker compose up`.
  - Любая поломка в Alembic-конфиге или несовместимость ревизии будет обнаружена ранним этапом CI/локального `pytest`.
- Ограничения:
  - Тест проверяет корректность bootstrap-миграции как процесса, но не заменяет будущие тесты бизнес-логики и конкурентного доступа к данным.
