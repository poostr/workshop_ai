# ADR-0004: Docker Compose и автозапуск миграций для INIT-004

## Статус

Принято.

## Контекст

Задача `INIT-004` требует:
- запуск локального окружения одной командой (`docker compose up --build`);
- три сервиса: `app`, `postgres`, `nginx`;
- раздачу SPA через `nginx` и проксирование `/api` в backend;
- автоматический прогон миграций при старте `app`.

При этом на текущем шаге бизнес-схема БД ещё не реализована (это scope этапа B), но миграционный контур уже должен быть рабочим.

## Решение

1. Для backend добавлена рабочая интеграция Alembic:
   - `backend/alembic.ini`;
   - `backend/alembic/env.py`;
   - стартовая ревизия `0001_init_schema_placeholder`.
2. Запуск `app` переведён на entrypoint-скрипт:
   - сначала `alembic upgrade head`;
   - затем запуск `uvicorn`.
3. Сервис `nginx` переведён на сборку собственного образа:
   - multi-stage Dockerfile собирает `frontend/dist` через Node;
   - финальный слой на базе `nginx` отдаёт только собранную статику.
4. В `docker-compose.yml` усилены зависимости по готовности:
   - healthcheck для `postgres` (`pg_isready`);
   - `app` стартует после `postgres: healthy`.

## Последствия

- Плюсы:
  - окружение соответствует требованию «одна команда запуска»;
  - `nginx` стабильно раздаёт production-артефакты из `dist`;
  - миграции автоматически применяются при старте backend.
- Минусы:
  - первая ревизия Alembic пока техническая (без DDL), полноценная схема появится в задачах `DB-001/DB-002`.
