# ADR-0018: Endpoint экспорта полного состояния (API-007)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: API-007

## Контекст

Следующая невыполненная задача этапа C требует реализовать endpoint `GET /api/v1/export`.

По PRD/TECHSPEC экспорт должен включать:

- полный перечень типов;
- актуальные counts по стадиям;
- полную append-only историю перемещений;
- детерминированный и валидный JSON-ответ, пригодный для последующего импорта.

Для следующей задачи импорта (`API-008`) важно, чтобы формат не зависел от внутренних DB id и был устойчивым к порядку чтения из БД.

## Решение

1. Добавить endpoint `GET /api/v1/export` в `backend/app/api/v1/router.py`.
2. Формат ответа определить через Pydantic-модели:
   - `ExportResponse` -> `types: list[ExportTypeItem]`;
   - `ExportTypeItem` -> `name`, `stage_counts`, `history`;
   - `ExportStageCount` -> `stage` (системный `StageCode`), `count`;
   - `ExportHistoryItem` -> `from_stage`, `to_stage`, `qty`, `created_at`.
3. Экспортировать типы в детерминированном порядке `name ASC, id ASC`.
4. Возвращать `stage_counts` строго по порядку системных стадий (`IN_BOX -> BUILDING -> PRIMING -> PAINTING -> DONE`), даже если значения нулевые.
5. Возвращать историю каждого типа полностью, в порядке `created_at ASC, id ASC`.
6. Зафиксировать контракт интеграционными тестами:
   - пустая БД;
   - заполненная БД с несколькими типами и историей.

## Последствия

- Положительные:
  - выполнен контракт API-007 и заложена предсказуемая база для `API-008` (import merge);
  - формат экспорта не привязан к внутренним идентификаторам и переносим между окружениями;
  - детерминированная сортировка упрощает тестирование и сравнение экспортов.
- Ограничения:
  - экспорт отдает полный снимок состояния целиком; для очень больших наборов данных возможна будущая задача по стримингу или chunked-экспорту.
