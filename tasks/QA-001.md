# Отчет по задаче QA-001: Инфраструктура тестов backend с реальным Postgres

## Что было сделано
1. Добавлен `docker-compose.test.yml` для запуска тестов в изолированном окружении с реальной БД Postgres (`test-db`) и приложением (`test-app`). Тестовая база данных и приложение запускаются совместно, и контейнер приложения автоматически прогоняет `pytest`.
2. Обновлен `Makefile`. Команда `make backend-test` теперь использует `docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from test-app`.
3. Внесены изменения в `backend/tests/conftest.py`. Удалено использование in-memory SQLite баз `sqlite+pysqlite`. Добавлена новая глобальная фикстура `database_url`, которая:
   - Подключается к тестовому инстансу Postgres.
   - Очищает схему `public` (каскадный drop).
   - Накатывает последнюю миграцию Alembic (`alembic upgrade head`).
   - Переопределяет переменную окружения `DATABASE_URL` через `monkeypatch`, чтобы сам FastAPI инстанс также использовал тестовую базу.
4. Выполнен рефакторинг всех тестовых файлов (`test_*.py`). Полностью удалено локальное применение миграций и работа с файловыми БД `tmp_path` для SQLite. Все тесты переведены на использование единой фикстуры `database_url`.
5. Тесты провалились из-за сравнения дат без учета часовых поясов, поэтому был написан скрипт, форматирующий ожидаемые даты в тестах в UTC-формате (с постфиксом `Z`, `T10:00:00Z`).
6. После фиксов все 25 юнит/интеграционных тестов успешно проходят в контейнере `test-app` на реальной базе Postgres. 

## Принятые решения
- **Postgres в тестах**: Тестирование конкурентных запросов (в частности, `FOR UPDATE` блокировки) невозможно адекватно покрыть, используя SQLite, поэтому переход на реальный Postgres обязателен для обеспечения надежности move-операций.

## Ссылки
- ADR: Нет новых ADR для этой задачи, так как архитектурное решение (использование Postgres) уже было заложено в требованиях (QA-001).
