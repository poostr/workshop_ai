# ADR-0020: Приборка этапа C (валидации, CORS, proxy-path)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: CLEAN-003

## Контекст

После реализации этапа C (`API-001` ... `API-008`) в backend остались признаки технического долга:

- часть правил валидации импорта была распределена между схемами и роутером;
- маппинг стадий в поля ответа дублировался в ручном виде;
- CORS и proxy-path требовали явного "secure-by-default" закрепления для локального окружения.

По DOD задачи `CLEAN-003` нужно убрать дублирование, централизовать валидации и проверить безопасность CORS/proxy-конфигурации.

## Решение

1. Централизована валидация import payload на уровне схем:
   - в `ImportTypeItem` (`backend/app/api/v1/schemas.py`) добавлен `model_validator`, который требует полный набор системных стадий без дублей.
2. Упрощен роутер импорта:
   - в `backend/app/api/v1/router.py` функция `_build_stage_delta_map` больше не дублирует проверки состава стадий и только преобразует данные в map.
3. Убран дублирующий ручной маппинг стадий в `TypeStageCounts`:
   - в роутере введен единый словарь `STAGE_COUNT_FIELD_BY_STAGE`;
   - добавлен helper `_stage_counts_model_from_dict`, который используется для инициализации counts.
4. Закреплена безопасная локальная CORS-конфигурация:
   - в `backend/app/main.py` подключен `CORSMiddleware` с allowlist локальных origin;
   - в `backend/app/config.py` добавлен параметр `cors_allowed_origins` с безопасными default-значениями.
5. Уточнен nginx proxy-path:
   - в `ops/nginx/default.conf` добавлен redirect `/api -> /api/`;
   - proxy ограничен `location ^~ /api/`, отключен `proxy_redirect`.

## Последствия

- Положительные:
  - правила валидации импорта находятся в одном месте (Pydantic-схемы), что снижает риск рассинхронизации;
  - код роутера стал проще и легче поддерживается;
  - CORS/proxy поведение стало явным и предсказуемым для локального деплоя.
- Ограничения:
  - allowlist CORS по умолчанию ориентирован на localhost-сценарий v1;
  - при смене схемы деплоя origin-список нужно обновлять через env.
