# ADR-0031: Тесты импорта — all-or-nothing + merge семантика (QA-004)

## Статус
Принято

## Контекст
Endpoint `POST /api/v1/import` реализован в API-008, но тестовое покрытие было минимальным:
3 теста покрывали базовый merge, rollback на дублированных стадиях и отсутствие стадий.
Для подтверждения DoD задачи QA-004 требовалось расширить покрытие на:
- откат при полностью невалидном JSON / невалидных стадиях / отрицательных count;
- атомарность all-or-nothing (изменения ранее валидных типов откатываются);
- merge-семантику: суммирование counts + append истории;
- edge-cases: пустой импорт, повторный импорт (no dedupe), extra-поля.

## Решение

### Структура тестов
- Вынесен helper `_all_stages_zero(overrides)` для DRY при построении stage_counts payload.
- Вынесена константа `ERR_INVALID_IMPORT_FORMAT` для единообразия assert'ов.
- Тесты разделены на две логические группы:
  1. **Merge-семантика** (5 тестов): создание нового типа, merge существующего, повторный импорт, пустой импорт.
  2. **Rollback / валидация** (7 тестов): малформед payload, невалидные стадии в counts/history, отрицательный count, extra-поля, атомарность при частично невалидном payload.

### Валидация vs DB-level rollback
Большинство ошибочных сценариев перехватываются на уровне Pydantic-валидации в `_parse_import_payload`,
до начала DB-транзакции. Это by design: строгая валидация входа (`extra="forbid"`, `StageCode` enum,
`model_validator`) отсеивает невалидные данные ещё до обращения к БД.
DB-level rollback покрывается тестом с дублированными стадиями (IntegrityError в транзакции).

### Исправление pre-existing lint-ошибок
- Удалены неиспользуемые `from pathlib import Path` из 5 тестовых файлов.
- В `conftest.py` добавлен `noqa: E402` для намеренного позднего импорта после модификации `sys.path`.

## Последствия
- Тестовое покрытие import endpoint выросло с 3 до 12 тестов.
- Все 49 backend-тестов проходят, lint чист.
- Lint-ошибки в тестовых файлах устранены для стабильности CI.
