# ADR-0010: Автоматическое сидирование stage_counts при создании типа (DB-003)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: DB-003

## Контекст

По требованиям `TECHSPEC.md` и `BACKLOG.md` у каждого типа миниатюр должны существовать счётчики по всем 5 стадиям сразу после создания типа.  
Если это оставить только на уровне будущего API-слоя, инвариант можно нарушить прямой вставкой в БД или обходным сценарием.

Дополнительно в текущем проекте миграции валидируются в тестах на SQLite, тогда как production-цель — PostgreSQL.

## Решение

1. Зафиксировать инвариант на уровне БД в отдельной Alembic-ревизии `0002_seed_stage_counts_on_type_insert`.
2. Добавить авто-сидирование через `AFTER INSERT` trigger на таблицу `miniature_types`:
   - PostgreSQL: триггерная функция `seed_stage_counts_for_new_type()` + trigger `trg_seed_stage_counts_after_type_insert`;
   - SQLite: эквивалентный trigger без функции (совместимый синтаксис).
3. Добавить интеграционный тест миграций, который после `alembic upgrade head` вставляет тип и проверяет, что в `stage_counts` появились 5 записей с нулевыми значениями.

## Последствия

- Положительные:
  - Инвариант «полный набор `stage_counts` для каждого типа» соблюдается независимо от прикладного кода.
  - Снижается риск расхождений между data layer и API/UI в следующих этапах.
  - Тест подтверждает поведение на уровне миграций и предотвращает регресс.
- Ограничения:
  - Логика сидирования теперь привязана к триггерам БД и должна учитываться при дальнейших изменениях схемы.
