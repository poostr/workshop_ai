# QA-004: Tests: import all-or-nothing + merge семантика

## Статус: Выполнено

## Что сделано

### Расширен файл тестов `backend/tests/test_import_api.py`

**Рефакторинг**:
- `_all_stages_zero(overrides)` — helper для построения stage_counts payload без дублирования
- `ERR_INVALID_IMPORT_FORMAT` — константа для единообразия assert'ов ошибок

**Новые тесты (9 шт.)**:

Merge-семантика:
- `test_post_import_creates_new_type_with_counts_and_history` — чистое создание типа (не merge)
- `test_post_import_repeated_import_doubles_counts_and_history` — повторный импорт удваивает counts и дублирует историю (no dedupe per PRD)
- `test_post_import_empty_types_list_is_noop` — пустой импорт → 200, без побочных эффектов

Rollback / валидация:
- `test_post_import_rejects_completely_malformed_payload` — отсутствие ключа `types`
- `test_post_import_rejects_invalid_stage_name_in_counts` — невалидное имя стадии в stage_counts
- `test_post_import_rejects_invalid_stage_name_in_history` — невалидное имя стадии в history
- `test_post_import_rejects_negative_count` — отрицательный count
- `test_post_import_rejects_extra_fields` — лишние поля в payload (`extra="forbid"`)
- `test_post_import_atomicity_valid_type_rolled_back_when_later_type_fails` — изменения валидного типа откатываются при невалидном последующем типе

**Сохранённые тесты (3 шт., рефакторены)**:
- `test_post_import_merges_counts_and_appends_history` — merge по имени
- `test_post_import_rolls_back_all_changes_on_invalid_payload` — rollback на дублированных стадиях
- `test_post_import_rejects_missing_stage_counts` — отклонение неполного набора стадий

### Дополнительные исправления
- Удалены неиспользуемые импорты `pathlib.Path` из 5 тестовых файлов
- Добавлен `noqa: E402` в `conftest.py` для позднего импорта

## Результаты
- 49 тестов passed (40 существующих + 9 новых)
- Backend lint: 0 ошибок

## ADR
- [ADR-0031](../ADR/ADR-0031-import-tests-qa-004.md)
