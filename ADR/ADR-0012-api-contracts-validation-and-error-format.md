# ADR-0012: Базовый контракт API — коды ошибок, единый формат и строгая валидация (API-001)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: API-001

## Контекст

На старте этапа C backend имел только технический endpoint `GET /api/v1/status` без формализованных API-контрактов:

- отсутствовал единый формат JSON-ошибок;
- не был зафиксирован базовый набор кодов бизнес-ошибок;
- не было базовых Pydantic-схем для строгой валидации входа;
- системные стадии существовали как строковые константы, но без enum-типа для API-контрактов.

Для следующих задач этапа C (`API-002`...`API-008`) нужен единый фундамент контрактов, чтобы исключить расхождение форматов ошибок и правил валидации.

## Решение

1. Ввести общий слой API-ошибок (`backend/app/api/v1/errors.py`):
   - enum `ErrorCode` с базовыми кодами (`ERR_VALIDATION`, `ERR_INVALID_STAGE`, `ERR_INVALID_STAGE_TRANSITION`, `ERR_INSUFFICIENT_QTY`, `ERR_DUPLICATE_TYPE_NAME`);
   - исключение `ApiContractError` для бизнес-ошибок;
   - единые handlers для `ApiContractError` и `RequestValidationError` с ответом формата `{code, message}` и HTTP 400.
2. Ввести базовые Pydantic-схемы (`backend/app/api/v1/schemas.py`):
   - `ApiStatusResponse` для системного endpoint;
   - `ErrorResponse` для контрактного формата ошибок;
   - `TypeMoveRequest` как канонический пример strict-входа (`strict=True`, `extra='forbid'`, `qty > 0`).
3. Уточнить доменный контракт стадий:
   - добавить `StageCode` (`StrEnum`) в `backend/app/domain/stages.py`;
   - формировать `STAGES` из enum, сохранив совместимость data-layer и миграций.
4. Зафиксировать поведение тестами (`backend/tests/test_api_contracts.py`):
   - единый формат бизнес-ошибки;
   - единый формат ошибки валидации;
   - строгая типовая валидация входных данных.

## Последствия

- Положительные:
  - Ошибки API теперь предсказуемы и готовы к i18n-маппингу на frontend по `code`.
  - Снижен риск дрейфа контрактов при реализации следующих endpoint’ов.
  - Валидация входа становится более строгой и безопасной по умолчанию.
- Ограничения:
  - Текст `message` сейчас технический; продуктовые формулировки и детализация будут уточняться по мере реализации endpoint’ов.
  - Направление перехода стадий (только вперёд) остаётся бизнес-правилом `API-005`, а не частью базовой структурной схемы запроса.
