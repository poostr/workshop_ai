# ADR-0015: Endpoint деталей типа миниатюр (API-004)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: API-004

## Контекст

Следующая невыполненная задача этапа C требует реализовать `GET /api/v1/types/{id}` с инвариантами:

- карточка типа должна возвращать имя и counts по всем 5 стадиям;
- результат должен быть консистентен с уже реализованным контрактом списка типов;
- дублирование логики построения `counts` между endpoint'ами не должно накапливаться.

Также нужно определить поведение для случая, когда тип с указанным `id` отсутствует.

## Решение

1. Реализовать endpoint `GET /api/v1/types/{id}` в `backend/app/api/v1/router.py`:
   - использовать `LEFT JOIN` с `stage_counts` для получения данных одним запросом;
   - формировать ответ в формате `TypeListItem` с обязательным присутствием всех стадий;
   - при отсутствии записи возвращать `404` (`Type not found.`).
2. Устранить дублирование логики инициализации/заполнения стадий:
   - добавить helper `_build_type_item` для создания структуры counts по умолчанию;
   - добавить helper `_apply_stage_count` для маппинга stage code -> поле ответа.
3. Подтвердить контракт интеграционными тестами:
   - успешный возврат карточки с заполненными и нулевыми стадиями;
   - `404` для несуществующего `type_id`.

## Последствия

- Положительные:
  - закрыт обязательный контракт API для экрана деталей типа;
  - уменьшено дублирование и повышена поддерживаемость роутера;
  - подготовлена стабильная база для следующих задач (`move`, `history`, `import/export`).
- Ограничения:
  - сообщение `404` пока остаётся текстовым (без отдельного бизнес-кода), что допустимо для транспортной ошибки "ресурс не найден".
