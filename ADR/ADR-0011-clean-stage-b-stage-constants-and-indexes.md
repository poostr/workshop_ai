# ADR-0011: Приборка этапа B — единый источник стадий и целевые индексы (CLEAN-002)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: CLEAN-002

## Контекст

После выполнения задач `DB-001`...`DB-003` стадии были централизованы в `app/domain/stages.py`, но в миграциях и тестах оставались локальные строковые дубли значений стадий.

Также индексация исторических записей была ориентирована только на фильтрацию по `type_id`, тогда как целевой read-path по истории использует выборку по `type_id` с сортировкой по времени.

## Решение

1. Закрепить единственный источник истины стадий для data-layer:
   - добавить `STAGES_SQL_LIST` в `app/domain/stages.py`;
   - использовать его в SQLAlchemy-моделях и в Alembic-ревизии `0001_init_schema_placeholder`;
   - использовать `STAGES` в ревизии `0002_seed_stage_counts_on_type_insert` для генерации SQL-вставок без хардкода.
2. Уточнить индексную стратегию для этапа B:
   - убрать избыточные одиночные индексы по `stage_counts.type_id` и `history_logs.type_id`;
   - добавить составной индекс `ix_history_logs_type_id_created_at` для чтения истории по типу в хронологическом порядке.
3. Привести тест миграций к доменным константам (`STAGES`) для устранения повторов строковых литералов.

## Последствия

- Положительные:
  - Снижен риск рассинхронизации между доменными константами, моделями и миграциями.
  - Схема БД остаётся минимальной и без лишних индексов.
  - История читается эффективнее для ожидаемого паттерна запроса (`WHERE type_id = ? ORDER BY created_at`).
- Ограничения:
  - Изменение состава стадий теперь требует осознанного обновления доменных констант и миграций, как и раньше, но точка изменения стала единой.
