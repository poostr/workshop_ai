# План реализации и содержимое BACKLOG.md

Ниже — задачи‑промпты для coding agent. Основано на `[PRD.md](PRD.md)` и `[TECHSPEC_GEMINI.md](TECHSPEC_GEMINI.md)`.

## Глобальные константы и инварианты (использовать во всех задачах)

- **Стадии (фиксированный порядок)**: `IN_BOX -> BUILDING -> PRIMING -> PAINTING -> DONE`.
- **Правила перемещения**: только **вперёд** по порядку стадий; `DONE` финальная.
- **Сущности**: тип миниатюр (уникальное имя), счётчики по стадиям (count >= 0), append-only история перемещений.
- **Группировка истории (read-time)**: соседние события группируются, если переход одинаковый и разница времени между ними <= 300 секунд (5 минут) и события подряд; timestamp группы = время первого события группы.
- **Импорт**: **all-or-nothing транзакция**, merge по имени типа: counts суммируются (по стадиям), history append; **dedupe не делаем**.
- **Локализация**: RU/EN, **никаких хардкодов строк** в UI; backend возвращает **коды ошибок**, UI маппит через i18n.
- **Деплой**: `docker-compose` локально; выбранный вариант: отдельный `nginx` для статики фронтенда + `app` (FastAPI) + `postgres`.

---

## Этап A — Инициализация (Repo, infra, DX)

- [x] INIT-001 Scaffold репозитория (backend/frontend/ops)
Task Context
- Репозиторий пустой (в workspace только docs). Нужно создать структуру, чтобы дальше задачи могли ссылаться на пути.
- Структура (минимум):
  - `backend/` (FastAPI + Alembic + тесты)
  - `frontend/` (React+TS)
  - `ops/` (nginx конфиги, скрипты)
  - `docker-compose.yml`, `.env.example`, `README.md`, `BACKLOG.md`
Task DOD
- Созданы директории и базовые файлы.
- `README.md` описывает запуск `docker compose up --build` и где лежат данные Postgres (volume), плюс предупреждение про `down -v`.

- [x] INIT-002 Bootstrap backend (FastAPI, конфиг, health)
Task Context
- Стек: Python + FastAPI, конфигурация через env (без секретов в репо).
- Нужны: структура приложения, роутинг `/api/v1`, health endpoint для compose.
- Запрет: не логировать содержимое экспорта/импорта; ошибки — коды.
Task DOD
- Backend запускается локально (в контейнере) и отвечает на `GET /health`.
- Конфиг читается через env (например, `DATABASE_URL`, `APP_ENV`, `LOG_LEVEL`).

- [x] INIT-003 Bootstrap frontend (React + TypeScript + сборка)
Task Context
- Выбран фронтенд: React + TS.
- Нужны: роутинг, базовый layout, подготовка i18n (RU/EN), API клиент каркас.
Task DOD
- `frontend` собирается в `dist/`.
- В dev-режиме UI открывается и отображает заглушку страниц `Main` и `TypeDetails`.

- [ ] INIT-004 Docker Compose (app + postgres + nginx)
Task Context
- Требование: локальный запуск одной командой. FastAPI отдельно от nginx.
- Nginx раздаёт `frontend/dist` и проксирует API на backend (например, `/api` -> `app:8000`).
- Postgres с volume.
Task DOD
- `docker compose up --build` поднимает 3 сервиса.
- Nginx отдаёт SPA и корректно проксирует API.
- Миграции БД накатываются при старте app контейнера.

- [ ] INIT-005 Quality gates (format/lint/test entrypoints)
Task Context
- Нужны быстрые команды для линтинга/форматирования/тестов backend и frontend.
- Цель: чтобы последующие задачи могли требовать «запусти линтер/тесты».
Task DOD
- Есть команды (Makefile или scripts) для:
  - backend: format + lint + pytest
  - frontend: format + lint + build + tests (если добавлены)

- [ ] INIT-006 Frontend typecheck как отдельный quality gate
Task Context
- На bootstrap этапе выявлен отдельный scope по согласованию tsconfig и среды,
  чтобы строгая типизация проверялась независимо от сборки.
Task DOD
- Добавлена воспроизводимая команда `frontend` для typecheck.
- Конфигурация TS стабильно проходит проверку в локальном окружении и в контейнере.

- [ ] CLEAN-001 Приборка этапа A
Task Context
- После создания каркаса легко накопить дубли и мусор.
Task DOD
- Удалены неиспользуемые шаблонные файлы.
- Приведены зависимости к минимально необходимым.
- Проверено отсутствие секретов и лишних логов.

---

## Этап B — Модель данных и миграции (Postgres + Alembic)

- [ ] DB-001 Реализовать схемы таблиц и ограничения
Task Context
- По TECHSPEC нужны таблицы:
  - `miniature_types` (уникальное `name`)
  - `stage_counts` (`type_id`, `stage_name`, `count >= 0`, unique(type_id, stage_name))
  - `history_logs` (append-only)
- `stage_name/from_stage/to_stage` должны быть ограничены системными константами стадий.
Task DOD
- Есть SQLAlchemy модели и/или явные Alembic migrations с:
  - UNIQUE на `miniature_types.name`
  - CHECK `stage_counts.count >= 0`
  - constraints/indexes для FK и уникальности `(type_id, stage_name)`

- [ ] DB-002 Alembic: init + миграции + автопрогон при старте
Task Context
- Требуется автоматическое накатывание `alembic upgrade head` при старте контейнера app.
Task DOD
- `backend` содержит Alembic конфиг и первую миграцию.
- `docker compose up` поднимает app, и схема оказывается созданной.

- [ ] DB-003 Сидирование stage_counts при создании типа
Task Context
- У каждого типа должны быть счётчики по всем стадиям, чтобы UI всегда мог показать числа.
- Значения по умолчанию: 0.
Task DOD
- После создания типа в БД существуют записи `stage_counts` на все 5 стадий.

- [ ] CLEAN-002 Приборка этапа B
Task Context
- Модель данных — база всего; важно убрать неоднозначности.
Task DOD
- В коде единственный источник истины стадий (Enum/const), без дублирования строк.
- Добавлены необходимые индексы (без преждевременной оптимизации).

---

## Этап C — Backend API и бизнес‑логика (FastAPI)

- [ ] API-001 Базовые контракты API: схемы, коды ошибок, валидация
Task Context
- Все endpoint’ы под `/api/v1`.
- Ошибки бизнес-логики: HTTP 400 + `code` (например `ERR_INSUFFICIENT_QTY`, `ERR_INVALID_STAGE_TRANSITION`, `ERR_DUPLICATE_TYPE_NAME`, `ERR_INVALID_STAGE`).
- Стадии в API — системные константы (`IN_BOX`, …).
Task DOD
- Единый обработчик ошибок и формат ответа ошибок.
- Pydantic схемы для запросов/ответов, строгая валидация входа.

- [ ] API-002 `GET /api/v1/types` список типов с агрегированными counts
Task Context
- Требование: сортировка по имени (А-Я/ASC).
- Ответ должен включать counts по стадиям.
Task DOD
- Endpoint возвращает список типов, отсортированный по `name ASC`.
- В ответе присутствуют counts для всех 5 стадий.

- [ ] API-003 `POST /api/v1/types` создание типа (уникальность имени)
Task Context
- Имя уникально: нельзя создать/переименовать с дубликатом.
- В v1 нужен минимум — создание.
Task DOD
- При дубликате возвращается 400 с `ERR_DUPLICATE_TYPE_NAME`.
- При успехе создаются stage_counts (см. DB-003).

- [ ] API-004 `GET /api/v1/types/{id}` детали типа
Task Context
- Нужны данные карточки: имя + counts.
Task DOD
- Endpoint возвращает тип и counts для всех стадий.

- [ ] API-005 `POST /api/v1/types/{id}/move` атомарное перемещение вперёд
Task Context
- Критический путь: нельзя уйти в минус; только вперёд.
- Транзакция + `SELECT ... FOR UPDATE` по источнику (пессимистическая блокировка).
- Проверка: `requested_qty <= available`.
- Записать событие в `history_logs`.
Task DOD
- При недостатке — 400 `ERR_INSUFFICIENT_QTY`.
- При неверном переходе (назад) — 400 `ERR_INVALID_STAGE_TRANSITION`.
- Разрешить переход на любую более позднюю стадию (X->Y), если Y находится позже X в фиксированном списке стадий.
- После успеха counts обновлены и возвращены.
- История пополнилась записью.

- [ ] API-006 `GET /api/v1/types/{id}/history` read-time группировка
Task Context
- В БД храним сырые события.
- Группируем только соседние, одинаковый `from->to`, разница времени <= 300с.
- Возвращаем группы с `timestamp` = время первого события группы.
Task DOD
- Endpoint возвращает массив групп, отсортированный по времени.
- Юнит-тестами подтверждены границы 299/300/301 секунд и правило «только соседние».

- [ ] API-007 `GET /api/v1/export` экспорт всего состояния
Task Context
- Экспорт JSON включает: типы, counts по стадиям, полную историю.
- Данные локальные; не логировать тело.
Task DOD
- Endpoint отдаёт валидный JSON со всем состоянием.

- [ ] API-008 `POST /api/v1/import` импорт JSON (merge + all-or-nothing)
Task Context
- Импорт поверх существующих данных: merge по имени.
- Если имя совпало: counts суммируются (по стадиям), history append.
- Dedup истории НЕ делаем.
- Любая ошибка формата/валидации должна откатить весь импорт.
Task DOD
- Импорт выполняется в одной транзакции.
- При ошибке БД остаётся неизменной.
- Возвращается понятный код ошибки (например, `ERR_INVALID_IMPORT_FORMAT`).

- [ ] CLEAN-003 Приборка этапа C + security check
Task Context
- После API легко разъезжаются контракты и валидации.
Task DOD
- Удалены дубли схем/Enum’ов стадий.
- Валидации централизованы.
- Проверено: CORS и прокси‑пути настроены безопасно для локального окружения.

---

## Этап D — Frontend SPA (React) + i18n + UX

- [ ] FE-001 Каркас приложения: роутинг, layout, состояние, i18n
Task Context
- Страницы: Main (список типов), TypeDetails (counts + move), History (вкладка/секция).
- RU/EN переключение «на лету» без потери состояния.
Task DOD
- i18n словари `ru/en` с ключами; строки в UI без хардкода.
- Есть UI переключатель языка.

- [ ] FE-002 Typed API client + маппинг кодов ошибок в i18n
Task Context
- Backend отдаёт `code`, фронтенд маппит в локализованный текст.
- Предпочтительно иметь единое место для API вызовов и ошибок.
Task DOD
- Реализован клиент для всех endpoint’ов v1.
- Ошибки отображаются как локализованные сообщения.

- [ ] FE-003 Main screen: список, сортировка, поиск, empty state + CTA
Task Context
- PRD: сортировка А-Я, поиск по названию.
- Empty state: CTA «Добавить тип», не авто-открывать модалку.
Task DOD
- Список сортируется по имени.
- Поиск фильтрует список.
- Empty state корректный.

- [ ] FE-004 Создание типа (модалка/страница) + обработка дубликатов
Task Context
- Нужно создать тип с уникальным именем.
- При `ERR_DUPLICATE_TYPE_NAME` показать понятное сообщение.
Task DOD
- Тип создаётся, список обновляется.
- Дубликаты обрабатываются UX-адекватно.

- [ ] FE-005 Type details: отображение counts и форма перемещения
Task Context
- UI перемещения: выбрать источник X и цель Y (только вперёд).
- Max available: `max = count(X)`, UI показывает «Доступно: N», нельзя отправить больше.
Task DOD
- Невозможные переходы недоступны в UI.
- Валидации на клиенте соответствуют PRD (и backend всё равно валидирует).

- [ ] FE-006 History UI: отображение групп
Task Context
- Показываем сгруппированные записи X→Y, qty(sum), timestamp начала группы.
Task DOD
- История отображает группы корректно, включая пограничные кейсы.

- [ ] FE-007 Export/Import UI
Task Context
- Экспорт: скачать JSON.
- Импорт: загрузить JSON, после успеха обновить UI.
- Повторный импорт может дублировать историю — это ок.
Task DOD
- Экспорт скачивает файл.
- Импорт обрабатывает ошибки формата и показывает локализованное сообщение.

- [ ] CLEAN-004 Приборка этапа D + security check
Task Context
- После UI итераций обычно остаются неиспользуемые компоненты/строки.
Task DOD
- Удалены неиспользуемые компоненты и ключи i18n.
- Проверено отсутствие утечек в консоль (не логировать экспорт/импорт целиком).

---

## Этап E — Тесты (backend, минимальный e2e)

- [ ] QA-001 Инфраструктура тестов backend с реальным Postgres
Task Context
- Для `SELECT FOR UPDATE` и транзакций нужен Postgres (sqlite не подходит).
- Нужна воспроизводимая команда запуска тестов.
Task DOD
- Тесты backend запускаются командой (локально или в контейнере) и используют отдельную тестовую БД.

- [ ] QA-002 Unit/Integration tests: move (конкурентность и инварианты)
Task Context
- Проверить: нет отрицательных остатков, неверные переходы запрещены.
- Конкурентные запросы на `/move`.
Task DOD
- Есть тесты на конкурентность (параллельные запросы), подтверждающие корректные итоговые counts.

- [ ] QA-003 Tests: history grouping границы времени
Task Context
- PRD: группируем соседние одинаковые переходы при разнице <= 300 секунд.
Task DOD
- Тесты покрывают 299/300/301 секунд и кейс «не соседние — не группировать».

- [ ] QA-004 Tests: import all-or-nothing + merge семантика
Task Context
- Импорт должен откатываться целиком при ошибке.
- Merge по имени: суммы counts и append истории.
Task DOD
- Тест подтверждает rollback на битом JSON/невалидных стадиях.
- Тест подтверждает sums и append при совпадении имени.

- [ ] QA-005 Minimal e2e smoke (опционально, но желательно)
Task Context
- Минимум: поднять docker compose, пройти сценарий create type -> move -> export/import -> history.
Task DOD
- Добавлен e2e smoke (Playwright или аналог) либо документирован ручной чеклист в `README.md`.

- [ ] CLEAN-005 Приборка этапа E
Task Context
- Тесты должны быть быстрыми и стабильными.
Task DOD
- Удалены флейки и лишние ожидания.
- Тестовые данные централизованы, нет дублирования.

---

## Этап F — Безопасность, приватность, операционка, финальная полировка

- [ ] SEC-001 Secrets & конфигурация (безопасно по умолчанию)
Task Context
- Никаких секретов в репо, всё через `.env`/env vars.
- Логи не должны содержать сырые данные экспорта.
Task DOD
- `.env.example` присутствует, `.env` в `.gitignore`.
- Логи редактированы/уровни настроены.

- [ ] SEC-002 Ограничения ввода и защита от больших импортов
Task Context
- Импорт JSON может быть большим; нужно выставить лимиты (размер тела, qty диапазоны).
Task DOD
- В backend есть лимит на размер импортируемого payload и строгая валидация полей.
- Ошибки возвращают коды, UI отображает локализовано.

- [ ] OPS-001 Hardening контейнеров и nginx конфигурации
Task Context
- Nginx для SPA + proxy API.
- Желательно: минимальный образ, non-root где возможно, healthchecks.
Task DOD
- Контейнеры собираются и запускаются стабильно.
- Nginx корректно отдаёт SPA (history fallback) и не открывает лишние пути.

- [ ] DOCS-001 Финальная документация пользователя
Task Context
- Пользователь запускает локально; важно объяснить backup/export и volume.
Task DOD
- `README.md` содержит:
  - запуск, обновление
  - экспорт/импорт
  - предупреждение про `docker compose down -v`

- [ ] CLEAN-006 Финальная приборка (dup removal, consistency, review)
Task Context
- Финальный проход по коду.
Task DOD
- Линтеры/форматтеры зелёные.
- Удалено дублирование констант стадий и контрактов.
- Быстрый security review: CORS, proxy, валидации, отсутствие утечек данных.

