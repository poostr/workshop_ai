# ADR-0008: Базовая схема БД и инварианты данных (DB-001)

- Статус: Accepted
- Дата: 2026-02-24
- Связанная задача: DB-001

## Контекст

На этапе B требуется перейти от placeholder-миграции к реальной схеме данных в Postgres для сущностей `miniature_types`, `stage_counts`, `history_logs` с жёсткими ограничениями целостности.

Критичные инварианты из PRD/TECHSPEC:
- имя типа миниатюр уникально;
- количество по стадии не может быть отрицательным;
- для пары `(type_id, stage_name)` существует не более одной записи;
- значения стадий должны быть ограничены системными константами;
- история append-only, с валидными стадиями и положительным `qty`.

## Решение

1. Ввести единый источник истины стадий в backend: `app/domain/stages.py` (`IN_BOX`, `BUILDING`, `PRIMING`, `PAINTING`, `DONE`).
2. Добавить SQLAlchemy-модели и декларативную базу:
   - `miniature_types`;
   - `stage_counts`;
   - `history_logs`.
3. Обновить Alembic `env.py`, подключив `Base.metadata` для миграций.
4. Заменить ревизию `0001_init_schema_placeholder` на создание реальной схемы с ограничениями:
   - `UNIQUE` на `miniature_types.name`;
   - `CHECK count >= 0` для `stage_counts`;
   - `UNIQUE(type_id, stage_name)` для `stage_counts`;
   - `CHECK IN (...)` для stage-полей в `stage_counts` и `history_logs`;
   - `CHECK qty > 0` для `history_logs`;
   - `FK ... ON DELETE CASCADE` + индексы по `type_id`.

## Последствия

- Положительные:
  - Инварианты данных закреплены на уровне БД и не зависят только от прикладного кода.
  - Схема готова как фундамент для API-слоя этапа C.
  - Единый набор stage-констант снижает риск рассинхронизации между слоями.
- Ограничения:
  - Валидация "переход только вперёд" остаётся задачей бизнес-логики API, а не SQL-constraint.
