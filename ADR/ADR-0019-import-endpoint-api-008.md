# ADR-0019: Endpoint импорта состояния (API-008)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: API-008

## Контекст

Нужно реализовать `POST /api/v1/import` по требованиям PRD/TECHSPEC:

- импорт выполняется как merge по имени типа;
- `stage_counts` суммируются по стадиям;
- история дописывается без dedupe;
- весь импорт должен быть `all-or-nothing` с полным rollback при любой ошибке.

Также нужен стабильный контракт ошибок для невалидного импортируемого JSON.

## Решение

1. Добавлен endpoint `POST /api/v1/import` в `backend/app/api/v1/router.py`.
2. Введены Pydantic-модели импорта (`ImportRequest`, `ImportTypeItem`, `ImportStageCount`, `ImportHistoryItem`, `ImportResponse`) в `backend/app/api/v1/schemas.py`.
3. Тело запроса валидируется явно через `ImportRequest.model_validate(...)`, а ошибки формата нормализуются в бизнес-код `ERR_INVALID_IMPORT_FORMAT`.
4. Импорт выполняется в одной транзакции (`with db_session.begin():`):
   - type-resolve по имени (`MiniatureType.name`);
   - при отсутствии типа — создание нового;
   - суммирование счетчиков по всем системным стадиям;
   - append истории в `history_logs`.
5. Добавлена проверка целостности `stage_counts` в payload:
   - запрещены дубли стадий;
   - требуется полный набор из 5 системных стадий.
6. Добавлен новый код ошибки `ERR_INVALID_IMPORT_FORMAT` в `backend/app/api/v1/errors.py`.

## Последствия

- Положительные:
  - выполнен контракт API-008 и закрыт критичный путь восстановления/переноса данных;
  - rollback гарантирует отсутствие частично примененного импорта;
  - ошибка формата импорта стабильно маппится во фронтенде через единый код.
- Ограничения:
  - импорт ожидает полный набор `stage_counts` по всем стадиям; частичные payload в v1 считаются невалидными.
