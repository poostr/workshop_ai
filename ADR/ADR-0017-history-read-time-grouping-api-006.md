# ADR-0017: Read-time группировка истории (API-006)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: API-006

## Контекст

Следующая невыполненная задача этапа C требует реализовать endpoint `GET /api/v1/types/{id}/history`.

По PRD/TECHSPEC:

- в БД должны храниться сырые события перемещений (append-only);
- группировка выполняется на чтении;
- объединяются только соседние события с одинаковым переходом `from->to`;
- разница времени между соседними событиями в группе должна быть `<= 300` секунд;
- timestamp группы должен соответствовать времени первого события группы.

Нужны воспроизводимые тесты на границы `299/300/301` и правило «только соседние».

## Решение

1. Добавить endpoint `GET /api/v1/types/{id}/history` в `backend/app/api/v1/router.py`.
2. Выбирать события из `history_logs` по `type_id` в порядке `created_at ASC, id ASC`, чтобы обеспечить стабильную последовательность.
3. Выполнять группировку в Python:
   - сравнивать текущую запись только с предыдущей записью последовательности;
   - при совпадении перехода и дельте времени `<= 300` секунд суммировать `qty` в текущую группу;
   - иначе начинать новую группу;
   - `timestamp` группы фиксировать по первому событию группы.
4. Для контракта ответа добавить схемы `TypeHistoryGroup` и `TypeHistoryResponse`.
5. Зафиксировать поведение интеграционными тестами для:
   - границ `299/300/301` секунд;
   - отсутствия группировки одинаковых, но несоседних переходов.

## Последствия

- Положительные:
  - выполнен контракт PRD по read-time группировке без усложнения схемы БД;
  - алгоритм линейный по числу событий и детерминирован за счёт стабильной сортировки;
  - тестами закреплены пограничные случаи и ключевой инвариант «только соседние».
- Ограничения:
  - при очень больших объёмах истории текущая реализация читает события типа целиком; возможная оптимизация пагинации остаётся отдельным будущим scope.
