# ADR-0014: Endpoint создания типа миниатюр (API-003)

- Статус: Accepted
- Дата: 2026-02-25
- Связанная задача: API-003

## Контекст

Первая невыполненная задача этапа C требует реализовать `POST /api/v1/types` с инвариантами:

- имя типа должно быть уникальным;
- при дублировании API должен вернуть `400` с кодом `ERR_DUPLICATE_TYPE_NAME`;
- после создания должны существовать `stage_counts` для всех стадий (инвариант DB-003).

Требуется сохранить единый формат API-контрактов и не дублировать стадии в endpoint-логике.

## Решение

1. Добавить request-схему `TypeCreateRequest` в `backend/app/api/v1/schemas.py`:
   - строгая валидация (`strict=True`, `extra='forbid'`);
   - `str_strip_whitespace=True` для предотвращения ложных дублей из-за краевых пробелов;
   - ограничение длины имени `1..255`.
2. Реализовать endpoint `POST /api/v1/types` в `backend/app/api/v1/router.py`:
   - создание записи `MiniatureType`;
   - `201 Created` и ответ формата `TypeListItem` с нулевыми counts по всем стадиям;
   - обработка `IntegrityError` с детекцией duplicate-констрейнта (`uq_miniature_types_name` / `miniature_types.name`) и маппингом в `ApiContractError(ErrorCode.ERR_DUPLICATE_TYPE_NAME)`.
3. Подтвердить контракт интеграционными тестами:
   - успешное создание типа;
   - ошибка при повторном имени;
   - проверка наличия `stage_counts` по всем стадиям после создания.

## Последствия

- Положительные:
  - API-слой закрывает обязательный контракт PRD/TECHSPEC для создания типа;
  - фронтенд получает предсказуемую бизнес-ошибку по дубликату;
  - подтверждена сквозная работа инварианта DB-003 на уровне API.
- Ограничения:
  - в текущей версии duplicate-детекция опирается на текст ошибки драйвера/constraint name; при смене диалекта БД может потребоваться уточнение матчинга.
